/*! microblog 2014-07-22 */
function checkLogin(a,b,c){a.session.user||(a.flash("error","未登录!"),b.redirect("/login")),c()}function checkNotLogin(a,b,c){a.session.user&&(a.flash("error","已登录!"),b.redirect("back")),c()}var crypto=require("crypto"),fs=require("fs"),User=require("../models/user.js"),Post=require("../models/post.js"),express=require("express"),router=express.Router();router.get("/",function(a,b){Post.get(null,function(c,d){c&&(d=[]),b.render("index",{title:"主页",user:a.session.user,posts:d,success:a.flash("success").toString(),error:a.flash("error").toString()})})}),router.get("/reg",checkNotLogin),router.get("/reg",function(a,b){b.render("reg",{title:"Register",user:a.session.user,success:a.flash("success").toString(),error:a.flash("error").toString()})}),router.post("/reg",checkNotLogin),router.post("/reg",function(a,b){var c=a.body.name,d=a.body.password,e=a.body["password-repeat"];if(e!=d)return a.flash("error","两次输入的密码不一致!"),b.redirect("/reg");var f=crypto.createHash("md5"),d=f.update(a.body.password).digest("hex"),g=new User({name:c,password:d,email:a.body.email});User.get(g.name,function(c,d){return d?(a.flash("error","用户已存在!"),b.redirect("/reg")):void g.save(function(c,d){return c?(a.flash("error",c),b.redirect("/reg")):(a.session.user=d,a.flash("success","注册成功!"),void b.redirect("/"))})})}),router.get("/login",checkNotLogin),router.get("/login",function(a,b){b.render("login",{title:"Login",user:a.session.user,success:a.flash("success").toString(),error:a.flash("error").toString()})}),router.post("/login",checkNotLogin),router.post("/login",function(a,b){var c=crypto.createHash("md5"),d=c.update(a.body.password).digest("hex");User.get(a.body.name,function(c,e){return e?e.password!=d?(a.flash("error","密码错误!"),b.redirect("/login")):(a.session.user=e,a.flash("success","登陆成功!"),void b.redirect("/")):(a.flash("error","用户不存在!"),b.redirect("/login"))})}),router.get("/post",checkLogin),router.get("/post",function(a,b){b.render("post",{title:"发表",user:a.session.user,success:a.flash("success").toString(),error:a.flash("error").toString()})}),router.post("/post",checkLogin),router.post("/post",function(a,b){var c=a.session.user,d=new Post(c.name,a.body.title,a.body.post);d.save(function(c){return c?(a.flash("error",c),b.redirect("/")):(a.flash("success","发布成功!"),void b.redirect("/"))})}),router.get("/logout",function(a,b){a.session.user=null,a.flash("success","登出成功!"),b.redirect("/")}),router.get("/upload",checkLogin),router.get("/upload",function(a,b){b.render("upload",{title:"文件上传",user:a.session.user,success:a.flash("success").toString(),error:a.flash("error").toString()})}),router.post("/upload",checkLogin),router.post("/upload",function(a,b){for(var c in a.files)if(0==a.files[c].size)fs.unlinkSync(a.files[c].path),console.log("Successfully removed an empty file!");else{var d="./public/images/"+a.files[c].name;fs.renameSync(a.files[c].path,d),console.log("Successfully renamed a file!")}a.flash("success","文件上传成功!"),b.redirect("/upload")}),module.exports=router;